# Claude Code ì‘ì—… ì¼ì§€

> ğŸ“¦ ìƒì„¸ íˆìŠ¤í† ë¦¬: `CLAUDE.md.backup_20251105` ì°¸ì¡°

---

## ğŸ”„ Development/Production Workflow

**âš ï¸ IMPORTANT**: This environment is a **development account**.

### Workflow Process
1. **Development**: Code changes and testing are performed in this development account
2. **Git Push**: Once tasks are completed, code is pushed to the git repository
3. **Production Testing**: Code is deployed and tested in a **production account** (which Claude Code cannot access)
4. **Error Feedback Loop**: If errors occur in production:
   - User provides error messages from the production account
   - Claude Code fixes the code in the development account
   - Fixed code is pushed to git and re-tested in production

This iterative process ensures that all code is properly tested before final production deployment.

---

## ğŸ¯ í”„ë¡œì íŠ¸ í˜„í™©

### âœ… Production Ready - VPC Runtime ì™„ì „ ì‘ë™

**í˜„ì¬ ìƒíƒœ**: VPC Private ëª¨ë“œì—ì„œ Multi-Agent Workflow ì™„ì „ ì‘ë™ í™•ì¸ (2025-11-04)

---

## ğŸš€ í˜„ì¬ ë°°í¬ ìƒíƒœ

### Production VPC Runtime

**Runtime ì •ë³´**:
- Runtime ID: `deep_insight_runtime_vpc-c0LVReFA3o`
- Runtime ARN: `arn:aws:bedrock-agentcore:us-east-1:057716757052:runtime/deep_insight_runtime_vpc-c0LVReFA3o`
- Network Mode: **VPC** (Test VPC: vpc-05975448296a22c21)
- Status: **READY** âœ…
- ìƒì„± ì‹œê°„: 2025-11-04 11:20:02 UTC

**ë„¤íŠ¸ì›Œí¬ êµ¬ì„±**:
- VPC CIDR: 10.100.0.0/16
- Subnet: subnet-0b2fb367d6e823a79 (Private, use1-az2)
- Security Group: sg-0affaea9ac4dc26b1
- Internal ALB: test-vpc-private-alb
- Target Group: test-vpc-private-tg

**ê²€ì¦ ì™„ë£Œ**:
- âœ… End-to-End ë„¤íŠ¸ì›Œí¬ í”Œë¡œìš° (Mac â†’ Bedrock â†’ VPC â†’ ALB â†’ Fargate)
- âœ… Fargate Container ì •ìƒ ì‘ë™ (ECR image pull, Health check, Code execution)
- âœ… Multi-Agent Workflow (Coder â†’ Validator â†’ Reporter)
- âœ… S3 File Sync
- âœ… PDF ë³´ê³ ì„œ ìƒì„±

---

## ğŸ“Š ì£¼ìš” AWS ë¦¬ì†ŒìŠ¤

### ECS/Fargate
- Cluster: `my-fargate-cluster`
- Task Definition: `fargate-dynamic-task:6`
- Docker Image: `057716757052.dkr.ecr.us-east-1.amazonaws.com/dynamic-executor:v19-fix-exec-exception`

### VPC Infrastructure
- Test VPC: `vpc-05975448296a22c21` (10.100.0.0/16)
- NAT Gateway: `nat-084c84d8f7ab9ac5c`
- VPC Endpoints: Bedrock AgentCore (2), ECR (2), CloudWatch Logs, S3

### Security Groups
- AgentCore: `sg-0affaea9ac4dc26b1`
- ALB: `sg-061896ca7967f6183`
- Fargate: `sg-0e1314a2421686c2c`
- VPC Endpoint: `sg-085cf66da6c4027d2`

### S3
- Bucket: `bedrock-logs-gonsoomoon`

---

## ğŸ”§ ìµœê·¼ í•´ê²°í•œ ì£¼ìš” ë¬¸ì œ

### 1. Fargate ë„¤íŠ¸ì›Œí¬ í™˜ê²½ ë³€ìˆ˜ ëˆ„ë½ (2025-11-05) ğŸš¨ Critical!
**ë¬¸ì œ**: Runtimeì´ Fargate ì»¨í…Œì´ë„ˆë¥¼ ì‹œì‘í•  ìˆ˜ ì—†ìŒ - ë„¤íŠ¸ì›Œí¬ ì„¤ì • ëˆ„ë½
**ê·¼ë³¸ ì›ì¸**: Phase 3 ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ê°€ Runtime .envì— 2ê°œì˜ í•„ìˆ˜ ë³€ìˆ˜ë¥¼ ì¶”ê°€í•˜ì§€ ì•ŠìŒ
- `FARGATE_SUBNET_IDS` âŒ
- `FARGATE_SECURITY_GROUP_IDS` âŒ

**í•´ê²°**: Phase 3 deploy.sh ìˆ˜ì • (scripts/phase3/deploy.sh:236-237)
```bash
FARGATE_SUBNET_IDS=${PRIVATE_SUBNET_1_ID},${PRIVATE_SUBNET_2_ID}
FARGATE_SECURITY_GROUP_IDS=${SG_FARGATE_ID}
```

**ì¶”ê°€ ìˆ˜ì •**:
- REQUIRED_VARSì— PRIVATE_SUBNET_1_ID, PRIVATE_SUBNET_2_ID, SG_FARGATE_ID ì¶”ê°€
- .bedrock_agentcore.yaml: 2ê°œ subnet ëª¨ë‘ í¬í•¨í•˜ë„ë¡ SUBNET_ARRAY ìˆ˜ì •
- .env.template, .env.example ì—…ë°ì´íŠ¸ (PRIVATE_SUBNET_ID â†’ PRIVATE_SUBNET_1_ID, PRIVATE_SUBNET_2_ID)

**ì˜í–¥**: Production Runtime ì¬ìƒì„± í•„ìš”

### 2. Security Group ê·œì¹™ ëˆ„ë½ (2025-11-05) â­ ì¤‘ìš”!
**ë¬¸ì œ**: Productionì—ì„œ Runtime ì‹œì‘ ì‹¤íŒ¨ - Fargate Containerê°€ ECR ì ‘ê·¼ ë¶ˆê°€
**ê·¼ë³¸ ì›ì¸**: Phase 1 CloudFormation í…œí”Œë¦¿ì— 3ê°œì˜ ì¤‘ìš”í•œ SG ê·œì¹™ ëˆ„ë½
- VPC Endpoint SG: HTTPS from VPC CIDR ëˆ„ë½ (ê°€ì¥ ì¤‘ìš”!)
- AgentCore SG: All traffic from VPC Endpoint (ê¸°ì¡´ HTTPSë§Œ)
- AgentCore SG: HTTPS from Fargate SG ëˆ„ë½

**í•´ê²°**: Phase 1 í…œí”Œë¦¿ì— ê·œì¹™ ì¶”ê°€ (production_deployment/cloudformation/phase1-infrastructure.yaml)
```yaml
# 1. VPC Endpoint SG: HTTPS from VPC CIDR
VPCESGIngressVPCCIDR:
  CidrIp: !GetAtt VPC.CidrBlock  # VPC CIDR ì „ì²´ í—ˆìš©

# 2. AgentCore SG: All from VPC Endpoint
AgentCoreSGIngressVPCE:
  IpProtocol: -1  # All traffic

# 3. AgentCore SG: HTTPS from Fargate
AgentCoreSGIngressFargate:
  FromPort: 443, ToPort: 443
  SourceSecurityGroupId: !Ref FargateSecurityGroup
```

**ì˜í–¥**: Production Stack Update í•„ìš”

### 3. OpenTelemetry (OTEL) í™˜ê²½ ë³€ìˆ˜ ì¶”ê°€ (2025-11-05) âœ…
**ëª©ì **: AgentCore Runtimeì—ì„œ per-invocation ë¡œê·¸ ìŠ¤íŠ¸ë¦¼ í™œì„±í™”
**ì¶”ê°€ëœ ë³€ìˆ˜** (production_deployment/.env.example):
```bash
OTEL_PYTHON_DISTRO=aws_distro
OTEL_PYTHON_CONFIGURATOR=aws_configurator
OTEL_EXPORTER_OTLP_PROTOCOL=http/protobuf
OTEL_EXPORTER_OTLP_LOGS_HEADERS=x-aws-log-group=bedrock-agentcore-observability,x-aws-log-stream=custom-spans,x-aws-metric-namespace=AgentCore
OTEL_RESOURCE_ATTRIBUTES=service.name=deep-insight-runtime
AGENT_OBSERVABILITY_ENABLED=true
```

**ìˆ˜ì •ëœ íŒŒì¼**:
- `production_deployment/.env.example`: OTEL ë³€ìˆ˜, Phase 2 ë³€ìˆ˜ ì¶”ê°€
- `01_create_agentcore_runtime.py`: OTEL ë³€ìˆ˜ ë¡œë“œ ë° Containerì— ì „ë‹¬ (lines 111-117, 292-304, 312-313)
  - âœ… **í”„ë¡œì íŠ¸ ë£¨íŠ¸ .env ë¡œë“œ** (line 83)
- `03_invoke_agentcore_job_vpc.py`: âœ… **í”„ë¡œì íŠ¸ ë£¨íŠ¸ .env ë¡œë“œ** (line 55)

**íš¨ê³¼**: CloudWatch Logsì—ì„œ Runtimeì˜ per-invocation ë¡œê·¸ ìŠ¤íŠ¸ë¦¼ ìƒì„±ë¨

**ìë™í™” ìŠ¤í¬ë¦½íŠ¸ ìƒì„±** (2025-11-05): âœ…
- `production_deployment/scripts/setup_env.sh`: CloudFormation Outputsì—ì„œ **.envë¥¼ í”„ë¡œì íŠ¸ ë£¨íŠ¸ì— ìë™ ìƒì„±**
  - Phase 1/2 Stack Outputs ìë™ ì½ê¸°
  - OTEL ë³€ìˆ˜ ìë™ ì¶”ê°€
  - ê¸°ì¡´ RUNTIME_ARN ë³´ì¡´
  - 35ê°œ í™˜ê²½ ë³€ìˆ˜ ì™„ì „ ìë™í™”
  - âœ… **í”„ë¡œì íŠ¸ ë£¨íŠ¸ì— .env ìƒì„±** (not production_deployment/.env)
- `production_deployment/README.md`: Environment Setup ì„¹ì…˜ ì¶”ê°€ (5ë‹¨ê³„ + ìƒì„¸ ê°€ì´ë“œ)

### 4. CloudWatch Logs Delivery ê¶Œí•œ ëˆ„ë½ (2025-11-05) ğŸš¨ Critical!
**ë¬¸ì œ**: AgentCore Runtimeì˜ per-invocation ë¡œê·¸ ìŠ¤íŠ¸ë¦¼ì´ ìƒì„±ë˜ì§€ ì•ŠìŒ
**ê·¼ë³¸ ì›ì¸**: Task Execution Roleì— CloudWatch Logs Delivery ê¶Œí•œ ëˆ„ë½
```
í˜„ì¬ (ê¸°ë³¸ ë¡œê¹…ë§Œ):
- logs:CreateLogGroup
- logs:CreateLogStream
- logs:PutLogEvents

ëˆ„ë½ëœ ê¶Œí•œ:
- âŒ logs:CreateDelivery
- âŒ logs:PutDeliverySource
- âŒ logs:PutDeliveryDestination
- âŒ logs:GetDelivery
- âŒ bedrock:AllowVendedLogDeliveryForResource
```

**í•´ê²°**: Phase 1 í…œí”Œë¦¿ ìˆ˜ì • (cloudformation/phase1-infrastructure.yaml)
```yaml
# CloudWatchLogsAccess (line 730-736):
Action:
  - logs:CreateLogGroup
  - logs:CreateLogStream
  - logs:PutLogEvents
  - logs:CreateDelivery          # ì¶”ê°€!
  - logs:PutDeliverySource       # ì¶”ê°€!
  - logs:PutDeliveryDestination  # ì¶”ê°€!
  - logs:GetDelivery             # ì¶”ê°€!
  - logs:DescribeDeliveries      # ì¶”ê°€!

# BedrockAccess (line 746, 821 - 2ê³³):
Action:
  - bedrock:InvokeModel
  - bedrock:InvokeModelWithResponseStream
  - bedrock:AllowVendedLogDeliveryForResource  # ì¶”ê°€!
```

**ì˜í–¥**: Production Stack Update í•„ìš”

### 4. ECS DescribeTaskDefinition ê¶Œí•œ ëˆ„ë½ (2025-11-05) ğŸš¨
**ë¬¸ì œ**: Runtimeì´ Fargate Taskë¥¼ ì‹œì‘í•  ìˆ˜ ì—†ìŒ - Task Definition ì¡°íšŒ ê¶Œí•œ ì—†ìŒ
**ê·¼ë³¸ ì›ì¸**: Task Execution Roleì˜ ECSAccess ì •ì±…ì— `ecs:DescribeTaskDefinition` ëˆ„ë½

**í•´ê²°**: Phase 1 í…œí”Œë¦¿ ìˆ˜ì • (cloudformation/phase1-infrastructure.yaml:757)
```yaml
Action:
  - ecs:RunTask
  - ecs:DescribeTasks
  - ecs:DescribeTaskDefinition  # ì¶”ê°€!
```

**ì˜í–¥**: Production Stack Update í•„ìš”

### 5. í™˜ê²½ ë³€ìˆ˜ ì´ë¦„ ë¶ˆì¼ì¹˜ (2025-11-05)
**ë¬¸ì œ**: Productionì—ì„œ Runtime ì‹œì‘ ì‹¤íŒ¨ - `TARGET_GROUP_ARN` vs `ALB_TARGET_GROUP_ARN` ë¶ˆì¼ì¹˜
**í•´ê²°**: ëª¨ë“  ìŠ¤í¬ë¦½íŠ¸ì™€ ë¬¸ì„œë¥¼ `ALB_TARGET_GROUP_ARN`ìœ¼ë¡œ í†µì¼
**ì˜í–¥**: Production Runtime ì¬ìƒì„± í•„ìš”

### 6. í™˜ê²½ íŒŒì¼ êµ¬ì¡° ì •ë¦¬ (2025-11-05) âœ…
**ë¬¸ì œ**: ì¤‘ë³µëœ .env íŒŒì¼ë“¤ë¡œ ì¸í•œ í˜¼ë€
- `production_deployment/.env` (ê°œë°œ ì „ìš©, í˜¼ë€ ì•¼ê¸°)
- `production_deployment/.env.template` (ì˜¤ë˜ë¨, OTEL ë° Phase 2 ë³€ìˆ˜ ëˆ„ë½)
- `production_deployment/.env.example` (í”„ë¡œì íŠ¸ ë£¨íŠ¸ì™€ ì¤‘ë³µ)

**í•´ê²°**:
1. âœ… `.gitignore` ìƒì„± (í”„ë¡œì íŠ¸ ë£¨íŠ¸) - .env íŒŒì¼ ì œì™¸, .env.example í¬í•¨
2. âœ… `production_deployment/.env` ì‚­ì œ (ê°œë°œ ì „ìš© ì„¤ì •)
3. âœ… `production_deployment/.env.template` ì‚­ì œ (ì˜¤ë˜ëœ í…œí”Œë¦¿)
4. âœ… `production_deployment/.env.example` ì‚­ì œ (ì¤‘ë³µ ì œê±°)

**ìµœì¢… êµ¬ì¡°**:
```
í”„ë¡œì íŠ¸ ë£¨íŠ¸/
â”œâ”€â”€ .env                    # ì‹¤ì œ í™˜ê²½ ë³€ìˆ˜ (Git ì œì™¸)
â”œâ”€â”€ .env.example            # í…œí”Œë¦¿ (Single source of truth, Git í¬í•¨)
â””â”€â”€ production_deployment/
    â””â”€â”€ scripts/
        â””â”€â”€ setup_env.sh    # í”„ë¡œì íŠ¸ ë£¨íŠ¸ì— .env ìë™ ìƒì„±
```

**íš¨ê³¼**:
- Single source of truth for environment templates
- ëª…í™•í•œ íŒŒì¼ ìœ„ì¹˜ (í”„ë¡œì íŠ¸ ë£¨íŠ¸ .env)
- Git ê´€ë¦¬ ë‹¨ìˆœí™”

---

## ğŸ¯ ë‹¤ìŒ ë‹¨ê³„

### Production ê³„ì • ë°°í¬
1. **Phase 1**: VPC, ALB, Security Groups, VPC Endpoints, IAM Roles
   - CloudFormation: `production_deployment/cloudformation/phase1-infrastructure.yaml`
   - ì˜ˆìƒ ì‹œê°„: 30-40ë¶„

2. **Phase 2**: ECR, Docker Image, ECS Cluster, Task Definition
   - CloudFormation: `production_deployment/cloudformation/phase2-fargate.yaml`
   - Three-Stage ë°°í¬ (ECR â†’ Docker â†’ Full Stack)
   - ì˜ˆìƒ ì‹œê°„: 15-20ë¶„

3. **Phase 3**: AgentCore Runtime VPC ëª¨ë“œ ìƒì„±
   - Script: `01_create_agentcore_runtime.py`
   - ì˜ˆìƒ ì‹œê°„: 10-15ë¶„

4. **Phase 4**: í†µí•© í…ŒìŠ¤íŠ¸ ë° ê²€ì¦
   - ì˜ˆìƒ ì‹œê°„: 10-30ë¶„

**ì´ ì˜ˆìƒ ì‹œê°„**: 65-105ë¶„ (ì•½ 1-2ì‹œê°„)

---

## ğŸ“š ì£¼ìš” ë¬¸ì„œ

### Production ë°°í¬ ê°€ì´ë“œ
- `production_deployment/README.md` - ë©”ì¸ ê°€ì´ë“œ
- `production_deployment/DEPLOYMENT_WORKFLOW.md` - ë°°í¬ ì›Œí¬í”Œë¡œìš°
- `production_deployment/PHASE3_QUICKSTART.md` - Phase 3 ë°°í¬ ê°€ì´ë“œ

### ìŠ¤í¬ë¦½íŠ¸
- `01_create_agentcore_runtime.py` - Runtime ìƒì„±/ì—…ë°ì´íŠ¸ (VPC ëª¨ë“œ)
- `02_agentcore_runtime.py` - Runtime ì‹¤í–‰ (ë¡œì»¬ í…ŒìŠ¤íŠ¸)
- `03_invoke_agentcore_job_vpc.py` - Runtime í˜¸ì¶œ (VPC)

### ë¶„ì„ ë³´ê³ ì„œ
- `assets/VPC_Job_ì‹¤í–‰_ë„¤íŠ¸ì›Œí¬_ì›Œí¬í”Œë¡œìš°_ë³´ê³ ì„œ.md` - VPC ë„¤íŠ¸ì›Œí¬ í”Œë¡œìš° ë¶„ì„
- `CLAUDE.md.backup_20251105` - ìƒì„¸ ì‘ì—… íˆìŠ¤í† ë¦¬ (1469ì¤„)

---

## ğŸ’° ë¹„ìš© ê³ ë ¤

**Test VPC ì›”ê°„ ë¹„ìš©** (24/7 ìš´ì˜ ì‹œ):
- NAT Gateway: ~$32.40/ì›”
- VPC Endpoints (Interface 5ê°œ): ~$36.00/ì›”
- Fargate Task (ì‹¤í–‰ ì‹œ): ~$0.04/ì‹œê°„
- **ì´ ~$68/ì›”**

**ê¶Œì¥**: í…ŒìŠ¤íŠ¸ ì™„ë£Œ í›„ ë¯¸ì‚¬ìš© ë¦¬ì†ŒìŠ¤ ì •ë¦¬ ê³ ë ¤

---

**ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸**: 2025-11-05
**ìƒíƒœ**: Production Ready - VPC Runtime ì™„ì „ ì‘ë™ âœ…
**í™˜ê²½**: Development Account (AWS Account: 057716757052)
